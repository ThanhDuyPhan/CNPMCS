var chatService=abp.services.app.chat,friendshipService=abp.services.app.friendship,appSession={load:function(n){abp.services.app.session.getCurrentLoginInformations({async:!1}).done(function(t){appSession.user=t.user;appSession.tenant=t.tenant;n()})}},chat={friends:[],tenantToTenantChatAllowed:abp.features.isEnabled("App.ChatFeature.TenantToTenant"),tenantToHostChatAllowed:abp.features.isEnabled("App.ChatFeature.TenantToHost"),serverClientTimeDifference:0,selectedUser:null,isOpen:!1,getFriendOrNull:function(n,t){var i=_.where(chat.friends,{friendUserId:parseInt(n),friendTenantId:t?parseInt(t):null});return i.length?i[0]:null},getFixedMessageTime:function(n){return moment(n).add(-1*chat.serverClientTimeDifference,"seconds").format("YYYY-MM-DDTHH:mm:ssZ")},getFriendsAndSettings:function(n){chatService.getUserChatFriendsWithSettings().done(function(t){chat.friends=t.friends;chat.serverClientTimeDifference=app.calculateTimeDifference(abp.clock.now(),t.serverTime,"seconds");chat.triggerUnreadMessageCountChangeEvent();chat.renderFriendLists(chat.friends);n()})},loadLastState:function(){app.localStorage.getItem("app.chat.isOpen",function(n){chat.isOpen=n;chat.adjustNotifyPosition();app.localStorage.getItem("app.chat.pinned",function(n){chat.pinned=n;var t=$("a.page-quick-sidebar-pinner");t.attr("class","page-quick-sidebar-pinner "+(chat.pinned?"pinned":"unpinned"))});chat.isOpen&&$("body, #m_quick_sidebar").addClass("m-quick-sidebar--on").promise().done(function(){$("#m_quick_sidebar .m-quick-sidebar__content").removeClass("m--hide");app.localStorage.getItem("app.chat.selectedUser",function(n){n?(chat.showMessagesPanel(),chat.selectFriend(n.friendUserId,n.friendTenantId)):chat.showFriendsPanel()})})})},changeChatPanelIsOpenOnLocalStorage:function(){app.localStorage.setItem("app.chat.isOpen",chat.isOpen)},changeChatUserOnLocalStorage:function(){app.localStorage.setItem("app.chat.selectedUser",chat.selectedUser)},changeChatPanelPinnedOnLocalStorage:function(){app.localStorage.setItem("app.chat.pinned",chat.pinned)},changeChatPanelPinned:function(n){chat.pinned=n;var t=$(".page-quick-sidebar-pinner");t.attr("class","page-quick-sidebar-pinner "+(chat.pinned?"pinned":"unpinned"));chat.changeChatPanelPinnedOnLocalStorage()},selectFriend:function(n,t){var i=chat.getFriendOrNull(n,t),r,u;chat.selectedUser=i;chat.changeChatUserOnLocalStorage();chat.user.setSelectedUserOnlineStatus(i.isOnline);chat.showMessagesPanel();chat.selectedUser.friendProfilePictureId?(r=chat.selectedUser.friendTenantId?chat.selectedUser.friendTenantId:"",$("#selectedChatUserImage").attr("src",abp.appPath+"Profile/GetFriendProfilePictureById?id="+chat.selectedUser.friendProfilePictureId+"&userId="+chat.selectedUser.friendUserId+"&tenantId="+r)):$("#selectedChatUserImage").attr("src",abp.appPath+"Common/Images/default-profile-picture.png");$("#selectedChatUserName").text(chat.user.getShownUserName(chat.selectedUser.friendTenancyName,chat.selectedUser.friendUserName));$("#ChatMessage").val("");chat.selectedUser.state!==app.consts.friendshipState.blocked?($("#liBanChatUser, #ChatMessageWrapper").show(),$("#liUnbanChatUser, #UnblockUserButton").hide(),$("#ChatMessage").removeAttr("disabled"),$("#ChatMessage").focus(),$("#SendChatMessageButton").removeAttr("disabled")):($("#liBanChatUser, #ChatMessageWrapper").hide(),$("#liUnbanChatUser, #UnblockUserButton").show(),$("#ChatMessage").attr("disabled","disabled"),$("#SendChatMessageButton").attr("disabled","disabled"));i.messagesLoaded?(u=chat.renderMessages(i.messages),$("#UserChatMessages").html(u),chat.scrollToBottom(),$(".timeago").timeago(),chat.user.markAllUnreadMessagesOfUserAsRead(chat.selectedUser)):chat.user.loadMessages(i,function(){i.messagesLoaded=!0;chat.scrollToBottom()})},initConversationScrollbar:function(){var n=$("#m_quick_sidebar").outerHeight(!0)-$(".selected-chat-user").outerHeight(!0)-$("#chatMessageForm").outerHeight(!0)-150;$(".m-messenger-conversation .m-messenger__messages").slimScroll({destroy:!0});$(".m-messenger-conversation .m-messenger__messages").slimScroll({height:n})},showMessagesPanel:function(){$(".m-messenger-friends").hide();$(".m-messenger-conversation").show(function(){chat.initConversationScrollbar();chat.scrollToBottom()});$("#m_quick_sidebar_back").removeClass("d-none")},showFriendsPanel:function(){$(".m-messenger-friends").show();$(".m-messenger-conversation").hide();$("#m_quick_sidebar_back").addClass("d-none")},changeFriendState:function(n,t){var i=chat.getFriendOrNull(n.friendUserId,n.friendTenantId);i&&(i.state=t,chat.renderFriendLists(chat.friends))},getFormattedFriends:function(n){return $.each(n,function(n,t){t.profilePicturePath=chat.getFriendProfilePicturePath(t);t.shownUserName=chat.user.getShownUserName(t.friendTenancyName,t.friendUserName)}),n},renderFriendList:function(n,t){var i=$("#UserFriendTemplate").html(),r;Mustache.parse(i);r=Mustache.render(i,n);t.html(r)},renderFriendLists:function(n){var t,i;n=chat.getFormattedFriends(n);t=_.where(n,{state:app.consts.friendshipState.accepted});chat.renderFriendList(t,$("#friendListFriends"));i=_.where(n,{state:app.consts.friendshipState.blocked});chat.renderFriendList(i,$("#friendListBlockeds"));t.length?$("#EmptyFriendListInfo").hide():$("#EmptyFriendListInfo").show();i.length?$("#EmptyBlockedFriendListInfo").hide():$("#EmptyBlockedFriendListInfo").show()},getFriendProfilePicturePath:function(n){if(!n.friendProfilePictureId)return abp.appPath+"Common/Images/default-profile-picture.png";var t=n.friendTenantId?n.friendTenantId:"";return abp.appPath+"Profile/GetFriendProfilePictureById?id="+n.friendProfilePictureId+"&userId="+n.friendUserId+"&tenantId="+t},sendMessage:function(){$("form[name='chatMessageForm']").valid()&&chat.selectedUser.state!==app.consts.friendshipState.blocked&&($("#SendChatMessageButton").attr("disabled","disabled"),app.chat.sendMessage({tenantId:chat.selectedUser.friendTenantId,userId:chat.selectedUser.friendUserId,message:$("#ChatMessage").val(),tenancyName:appSession.tenant?appSession.tenant.tenancyName:null,userName:appSession.user.userName,profilePictureId:appSession.user.profilePictureId},function(){$("#ChatMessage").val("");$("#SendChatMessageButton").removeAttr("disabled")}))},getFormattedMessages:function(n){return $.each(n,function(n,t){var u,r;if(t.creationTime=chat.getFixedMessageTime(t.creationTime),t.cssClass=t.side===app.chat.side.sender?"m-messenger__message--out":"m-messenger__message--in",t.isIn=t.side!==app.chat.side.sender,t.shownUserName=t.side===app.chat.side.sender?appSession.user.userName:chat.selectedUser.friendUserName,t.profilePicturePath=t.side===app.chat.side.sender?appSession.user.profilePictureId?abp.appPath+"Profile/GetProfilePictureById?id="+appSession.user.profilePictureId:abp.appPath+"Common/Images/default-profile-picture.png":chat.getFriendProfilePicturePath(chat.selectedUser),u=t.receiverReadState===app.chat.readState.read?" m--font-info":" m--font-secondary",t.readStateCheck=t.side===app.chat.side.sender?'<i class="read-state-check fa fa-check'+u+'" aria-hidden="true"><\/i>':"",t.message.startsWith("[image]")){var e=JSON.parse(t.message.substring(7)),i=abp.appPath+"AppAreaName/Chat/GetImage?id="+t.id+"&contentType="+e.contentType,o='<a href="'+i+'" target="_blank"><img src="'+i+'" class="chat-image-preview"><\/a>';t.formattedMessage=o}else if(t.message.startsWith("[file]")){var f=JSON.parse(t.message.substring(6)),i=abp.appPath+"AppAreaName/Chat/GetFile?id="+t.id+"&contentType="+f.contentType,s='<a href="'+i+'" target="_blank" class="chat-file-preview"><i class="la la-file"><\/i> '+f.name+' <i class="la la-download pull-right"><\/i><\/a>';t.formattedMessage=s}else t.message.startsWith("[link]")?(r=JSON.parse(t.message.substring(6)),t.formattedMessage='<a href="'+r.message+'" target="_blank" class="chat-link-message"><i class="fa fa-link"><\/i> '+r.message+"<\/a>"):t.formattedMessage=Mustache.escape(t.message)}),n},renderMessages:function(n){n=chat.getFormattedMessages(n);var t=$("#UserChatMessageTemplate").html();return Mustache.parse(t),Mustache.render(t,n)},scrollToBottom:function(){var n=$(".m-messenger-conversation .m-messenger__messages").prop("scrollHeight")+"px";$(".m-messenger-conversation .m-messenger__messages").slimScroll({scrollTo:n})},adjustNotifyPosition:function(){chat.isOpen?app.changeNotifyPosition("toast-chat-open"):app.changeNotifyPosition("toast-bottom-right")},triggerUnreadMessageCountChangeEvent:function(){var n=0;chat&&chat.friends&&(n=_.reduce(chat.friends,function(n,t){return n+t.unreadMessageCount},0));abp.event.trigger("app.chat.unreadMessageCountChanged",n)},bindUiEvents:function(){$("#m_quick_sidebar").mOffcanvas({"class":"m-quick-sidebar",close:$("#m_quick_sidebar_close"),toggle:$("#m_quick_sidebar_toggle")});$("#m_quick_sidebar").mOffcanvas().one("afterShow",function(){mApp.block($("#m_quick_sidebar"));setTimeout(function(){mApp.unblock($("#m_quick_sidebar"));$("#m_quick_sidebar").find(".m-quick-sidebar__content").removeClass("m--hide")},1e3)});$("#m_quick_sidebar").on("click","#m_quick_sidebar_back",function(){chat.selectedUser=null;chat.changeChatUserOnLocalStorage()});$("#m_quick_sidebar_toggle").on("click",function(){chat.isOpen=$("body").hasClass("m-quick-sidebar--on");chat.adjustNotifyPosition();chat.changeChatPanelIsOpenOnLocalStorage();chat.user.markAllUnreadMessagesOfUserAsRead(chat.selectedUser)});$(".m-messenger-friends").on("click",".m-list-search__result-item",function(){var n=$(this).attr("data-friend-user-id"),t=$(this).attr("data-friend-tenant-id");chat.selectFriend(n,t)});$("#m_quick_sidebar_back").on("click",function(){chat.showFriendsPanel()});$("#liBanChatUser a").click(function(){chat.user.block(chat.selectedUser)});$("#liUnbanChatUser, #UnblockUserButton").click(function(){chat.user.unblock(chat.selectedUser)});$(window).on("resize",function(){chat.initConversationScrollbar()});$("#SearchChatUserButton").click(function(){chat.user.search()});$("#ChatUserSearchUserName, #ChatUserSearchTenancyName").keypress(function(n){n.which===13&&chat.user.search()});$("#ChatMessage").keypress(function(n){n.which===13&&(n.preventDefault(),chat.sendMessage())});$("#ChatUserSearchUserName").on("keyup",function(){var n=$(this).val(),t;n?$("#SearchChatUserButton").removeClass("d-none"):$("#SearchChatUserButton").addClass("d-none");t=_.filter(chat.friends,function(t){return chat.user.getShownUserName(t.friendTenancyName,t.friendUserName).toLowerCase().indexOf(n.toLowerCase())>=0});chat.renderFriendLists(t)});$("div.m-quick-sidebar").on("mouseleave",function(n){chat.pinned||$(n.target).attr("data-toggle")==="m-popover"||($("body, #m_quick_sidebar").removeClass("m-quick-sidebar--on"),$("#m_quick_sidebar").mOffcanvas().hide(),chat.isOpen=!1,chat.adjustNotifyPosition(),chat.changeChatPanelIsOpenOnLocalStorage())});$("form[name='chatMessageForm']").validate({invalidHandler:function(){$("#SendChatMessageButton").attr("disabled","disabled")},errorPlacement:function(){},success:function(){$("#SendChatMessageButton").removeAttr("disabled")}});$(".page-quick-sidebar-pinner").click(function(){chat.changeChatPanelPinned(!chat.pinned)});!chat.tenantToTenantChatAllowed&&chat.tenantToHostChatAllowed&&$("#InterTenantChatHintIcon").hide()},registerEvents:function(){abp.event.on("app.chat.messageReceived",function(n){var t=chat.getFriendOrNull(n.targetUserId,n.targetTenantId),i;t&&(t.messages=t.messages||[],t.messages.push(n),n.side===app.chat.side.receiver&&(t.unreadMessageCount+=1,n.readState=app.chat.readState.unread,chat.user.changeUnreadMessageCount(t.friendTenantId,t.friendUserId,t.unreadMessageCount),chat.triggerUnreadMessageCountChangeEvent(),chat.isOpen&&chat.selectedUser!==null&&t.friendTenantId===chat.selectedUser.friendTenantId&&t.friendUserId===chat.selectedUser.friendUserId?chat.user.markAllUnreadMessagesOfUserAsRead(chat.selectedUser):abp.notify.info(abp.utils.formatString("{0}: {1}",t.friendUserName,abp.utils.truncateString(n.message,100)),null,{onclick:function(){$("body").hasClass("m-quick-sidebar--on")||($("body").addClass("m-quick-sidebar--on"),chat.isOpen=!0,chat.changeChatPanelIsOpenOnLocalStorage());chat.showMessagesPanel();chat.selectFriend(t.friendUserId,t.friendTenantId);chat.changeChatPanelPinned(!0)}})),chat.selectedUser!==null&&t.friendUserId===chat.selectedUser.friendUserId&&t.friendTenantId===chat.selectedUser.friendTenantId&&(i=chat.renderMessages([n]),$("#UserChatMessages").append(i),$(".timeago").timeago()),chat.scrollToBottom())});abp.event.on("app.chat.friendshipRequestReceived",function(n,t){t||abp.notify.info(abp.utils.formatString(app.localize("UserSendYouAFriendshipRequest"),n.friendUserName));_.where(chat.friends,{userId:n.friendUserId,tenantId:n.friendTenantId}).length||(chat.friends.push(n),chat.renderFriendLists(chat.friends))});abp.event.on("app.chat.userConnectionStateChanged",function(n){chat.user.setFriendOnlineStatus(n.friend.userId,n.friend.tenantId,n.isConnected)});abp.event.on("app.chat.userStateChanged",function(n){var t=chat.getFriendOrNull(n.friend.userId,n.friend.tenantId);t&&(t.state=n.state,chat.renderFriendLists(chat.friends))});abp.event.on("app.chat.allUnreadMessagesOfUserRead",function(n){var t=chat.getFriendOrNull(n.friend.userId,n.friend.tenantId);t&&(t.unreadMessageCount=0,chat.user.changeUnreadMessageCount(t.friendTenantId,t.friendUserId,t.unreadMessageCount),chat.triggerUnreadMessageCountChangeEvent())});abp.event.on("app.chat.readStateChange",function(n){var t=chat.getFriendOrNull(n.friend.userId,n.friend.tenantId);t&&($.each(t.messages,function(n,t){t.receiverReadState=app.chat.readState.read}),chat.selectedUser&&chat.selectedUser.friendUserId===n.friend.userId&&$(".read-state-check").not(".m--font-info").addClass("m--font-info"))});abp.event.on("app.chat.connected",function(){$("#chat_is_connecting_icon").hide();$("#m_quick_sidebar_toggle").removeClass("d-none");chat.getFriendsAndSettings(function(){chat.bindUiEvents();chat.loadLastState()})})},init:function(){chat.registerEvents();appSession.load(function(){chat.interTenantChatAllowed=abp.features.isEnabled("App.ChatFeature.TenantToTenant")||abp.features.isEnabled("App.ChatFeature.TenantToHost")||!appSession.tenant})},user:{loadingPreviousUserMessages:!1,userNameFilter:"",getShownUserName:function(n,t){return(n?n:".")+"\\"+t},block:function(n){friendshipService.blockUser({userId:n.friendUserId,tenantId:n.friendTenantId}).done(function(){chat.changeFriendState(n,app.consts.friendshipState.blocked);abp.notify.info(app.localize("UserBlocked"));$("#ChatMessage").attr("disabled","disabled");$("#SendChatMessageButton").attr("disabled","disabled");$("#liBanChatUser, #ChatMessageWrapper").hide();$("#liUnbanChatUser, #UnblockUserButton").show()})},unblock:function(n){friendshipService.unblockUser({userId:n.friendUserId,tenantId:n.friendTenantId}).done(function(){chat.changeFriendState(n,app.consts.friendshipState.accepted);abp.notify.info(app.localize("UserUnblocked"));$("#ChatMessage").removeAttr("disabled");$("#ChatMessage").focus();$("#SendChatMessageButton").removeAttr("disabled");$("#liBanChatUser, #ChatMessageWrapper").show();$("#liUnbanChatUser, #UnblockUserButton").hide()})},markAllUnreadMessagesOfUserAsRead:function(n){if(n&&chat.isOpen){var i=_.where(n.messages,{readState:app.chat.readState.unread}),t=_.pluck(i,"id");t.length&&chatService.markAllUnreadMessagesOfUserAsRead({tenantId:n.friendTenantId,userId:n.friendUserId}).done(function(){$.each(n.messages,function(n,i){t.indexOf(i.id)>=0&&(i.readState=app.chat.readState.read)})})}},changeUnreadMessageCount:function(n,t,i){var u,r;n||(n="");u=$('a.m-list-search__result-item[data-friend-tenant-id="'+n+'"][data-friend-user-id="'+t+'"]');u&&(r=$(u[0]).find("span.m-badge"),r.html(i),i?r.removeClass("d-none"):r.addClass("d-none"))},loadMessages:function(n,t){chat.user.loadingPreviousUserMessages=!0;var i=null;n.messages&&n.messages.length&&(i=_.min(n.messages,function(n){return n.id}).id);chatService.getUserChatMessages({minMessageId:i,tenantId:n.friendTenantId,userId:n.friendUserId}).done(function(i){n.messages||(n.messages=[]);n.messages=i.items.concat(n.messages);chat.user.markAllUnreadMessagesOfUserAsRead(n);i.items.length||(n.allPreviousMessagesLoaded=!0);var r=chat.renderMessages(n.messages);$("#UserChatMessages").html(r);$(".timeago").timeago();chat.user.loadingPreviousUserMessages=!1;t&&t()})},openSearchModal:function(n){var t=app.modals.LookupModal.create({title:app.localize("SelectAUser"),serviceMethod:abp.services.app.commonLookup.findUsers,filterText:$("#ChatUserSearchUserName").val(),extraFilters:{tenantId:n}});t.open({},function(n){var t=n.value;friendshipService.createFriendshipRequest({userId:t,tenantId:appSession.tenant!==null?appSession.tenant.id:null}).done(function(){$("#ChatUserSearchUserName").val("")})})},search:function(){var t=$("#ChatUserSearchUserName").val(),i="",n="",r;t.indexOf("\\")===-1?n=t:(r=t.split("\\"),i=r[0],n=r[1]);i&&chat.interTenantChatAllowed?friendshipService.createFriendshipRequestByUserName({tenancyName:i,userName:n}).done(function(){$("#ChatUserSearchUserName").val("")}):chat.user.openSearchModal(appSession.tenant?appSession.tenant.id:null,n)},setFriendOnlineStatus:function(n,t,i){var u=chat.getFriendOrNull(n,t),f,r;u&&(u.isOnline=i,f="contact-status1 "+(i?"online":"offline"),r=$('a.m-list-search__result-item[data-friend-tenant-id="'+(t?t:"")+'"][data-friend-user-id="'+n+'"]'),r&&$(r[0]).find(".contact-status1").attr("class",f),chat.selectedUser&&t===chat.selectedUser.friendTenantId&&n===chat.selectedUser.friendUserId&&chat.user.setSelectedUserOnlineStatus(i))},setSelectedUserOnlineStatus:function(n){if(chat.selectedUser){var t="contact-status2 "+(n?"online":"offline");$("#selectedChatUserStatus").attr("class",t)}}}};chat.init(),function(n){n(function(){var t=abp.appPath+"AppAreaName/Chat/UploadFile";n("#chatImageUpload").fileupload({url:t,dataType:"json",maxFileSize:999e3,done:function(t,i){var r=i.result;n("#ChatMessage").val('[image]{"id":"'+r.result.id+'", "name":"'+r.result.name+'", "contentType":"'+r.result.contentType+'"}');chat.sendMessage();n(".chat-progress-bar").hide()},progressall:function(t,i){var r=parseInt(i.loaded/i.total*100,10);n(".chat-progress-bar").show();n("#chatFileUploadProgress .progress-bar").css("width",r+"%")}}).prop("disabled",!n.support.fileInput).parent().addClass(n.support.fileInput?undefined:"disabled");n("#chatFileUpload").fileupload({url:t,dataType:"json",maxFileSize:999e3,done:function(t,i){var r=i.result;n("#ChatMessage").val('[file]{"id":"'+r.result.id+'", "name":"'+r.result.name+'", "contentType":"'+r.result.contentType+'"}');chat.sendMessage();n(".chat-progress-bar").hide()},progressall:function(t,i){var r=parseInt(i.loaded/i.total*100,10);n(".chat-progress-bar").show();n("#chatFileUploadProgress .progress-bar").css("width",r+"%")}}).prop("disabled",!n.support.fileInput).parent().addClass(n.support.fileInput?undefined:"disabled");n("#btnLinkShare").click(function(){n("#chatDropdownToggle").dropdown("toggle");n("#ChatMessage").val('[link]{"message":"'+window.location.href+'"}');chat.sendMessage()});n(".fileinput-button").click(function(){n("#chatDropdownToggle").dropdown("toggle")})})}(jQuery);