(function(){$(function(){var i=abp.services.app.organizationUnit,r={manageOrganizationTree:abp.auth.hasPermission("Pages.Administration.OrganizationUnits.ManageOrganizationTree"),manageMembers:abp.auth.hasPermission("Pages.Administration.OrganizationUnits.ManageMembers")},u=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/OrganizationUnits/CreateModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/OrganizationUnits/_CreateModal.js",modalClass:"CreateOrganizationUnitModal"}),f=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/OrganizationUnits/EditModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/OrganizationUnits/_EditModal.js",modalClass:"EditOrganizationUnitModal"}),e=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/OrganizationUnits/AddMemberModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/OrganizationUnits/_AddMemberModal.js",modalClass:"AddMemberModal",addMemberOptions:{title:app.localize("SelectAUser"),serviceMethod:i.findUsers}}),n={$tree:$("#OrganizationUnitEditTree"),$emptyInfo:$("#OrganizationUnitTreeEmptyInfo"),show:function(){n.$emptyInfo.hide();n.$tree.show()},hide:function(){n.$emptyInfo.show();n.$tree.hide()},unitCount:0,setUnitCount:function(t){n.unitCount=t;t?n.show():n.hide()},refreshUnitCount:function(){n.setUnitCount(n.$tree.jstree("get_json").length)},selectedOu:{id:null,displayName:null,code:null,set:function(i){i?(n.selectedOu.id=i.id,n.selectedOu.displayName=i.original.displayName,n.selectedOu.code=i.original.code):(n.selectedOu.id=null,n.selectedOu.displayName=null,n.selectedOu.code=null);t.load()}},contextMenu:function(u){return{editUnit:{label:app.localize("Edit"),icon:"la la-pencil",_disabled:!r.manageOrganizationTree,action:function(t){var i=$.jstree.reference(t.reference);f.open({id:u.id},function(t){u.original.displayName=t.displayName;i.rename_node(u,n.generateTextOnTree(t))})}},addSubUnit:{label:app.localize("AddSubUnit"),icon:"la la-plus",_disabled:!r.manageOrganizationTree,action:function(){n.addUnit(u.id)}},addMember:{label:app.localize("AddMember"),icon:"la la-user-plus",_disabled:!r.manageMembers,action:function(){t.openAddModal()}},"delete":{label:app.localize("Delete"),icon:"la la-remove",_disabled:!r.manageOrganizationTree,action:function(t){var r=$.jstree.reference(t.reference);abp.message.confirm(app.localize("OrganizationUnitDeleteWarningMessage",u.original.displayName),app.localize("AreYouSure"),function(t){t&&i.deleteOrganizationUnit({id:u.id}).done(function(){abp.notify.success(app.localize("SuccessfullyDeleted"));r.delete_node(u);n.refreshUnitCount()}).fail(function(n){setTimeout(function(){abp.message.error(n.message)},500)})})}}}},addUnit:function(t){var i=$.jstree.reference(n.$tree);u.open({parentId:t},function(r){i.create_node(t?i.get_node(t):"#",{id:r.id,parent:r.parentId?r.parentId:"#",code:r.code,displayName:r.displayName,memberCount:0,text:n.generateTextOnTree(r),state:{opened:!0}});n.refreshUnitCount()})},generateTextOnTree:function(n){var t=n.memberCount>0?" ou-text-has-members":" ou-text-no-members";return'<span title="'+n.code+'" class="ou-text'+t+'" data-ou-id="'+n.id+'">'+app.htmlUtils.htmlEncodeText(n.displayName)+' (<span class="ou-text-member-count">'+n.memberCount+'<\/span>) <i class="fa fa-caret-down text-muted"><\/i><\/span>'},incrementMemberCount:function(t,i){var r=n.$tree.jstree("get_node",t);r.original.memberCount=r.original.memberCount+i;n.$tree.jstree("rename_node",r,n.generateTextOnTree(r.original))},getTreeDataFromServer:function(t){i.getOrganizationUnits({}).done(function(i){var r=_.map(i.items,function(t){return{id:t.id,parent:t.parentId?t.parentId:"#",code:t.code,displayName:t.displayName,memberCount:t.memberCount,text:n.generateTextOnTree(t),state:{opened:!0}}});t(r)})},init:function(){n.getTreeDataFromServer(function(t){n.setUnitCount(t.length);n.$tree.on("changed.jstree",function(t,i){if(i.selected.length!=1)n.selectedOu.set(null);else{var r=i.instance.get_node(i.selected[0]);n.selectedOu.set(r)}}).on("move_node.jstree",function(t,r){var u=!r.parent||r.parent=="#"?app.localize("Root"):n.$tree.jstree("get_node",r.parent).original.displayName;abp.message.confirm(app.localize("OrganizationUnitMoveConfirmMessage",r.node.original.displayName,u),app.localize("AreYouSure"),function(t){t?i.moveOrganizationUnit({id:r.node.id,newParentId:r.parent}).done(function(){abp.notify.success(app.localize("SuccessfullyMoved"));n.reload()}).fail(function(t){n.$tree.jstree("refresh");setTimeout(function(){abp.message.error(t.message)},500)}):n.$tree.jstree("refresh")})}).jstree({core:{data:t,multiple:!1,check_callback:function(){return!0}},types:{"default":{icon:"fa fa-folder m--font-warning"},file:{icon:"fa fa-file  m--font-warning"}},contextmenu:{items:n.contextMenu},sort:function(n,t){return this.get_node(t).original.displayName<this.get_node(n).original.displayName?1:-1},plugins:["types","contextmenu","wholerow","sort","dnd"]});$("#AddRootUnitButton").click(function(t){t.preventDefault();n.addUnit(null)});n.$tree.on("click",".ou-text .fa-caret-down",function(t){t.preventDefault();var i=$(this).closest(".ou-text").attr("data-ou-id");setTimeout(function(){n.$tree.jstree("show_contextmenu",i)},100)})})},reload:function(){n.getTreeDataFromServer(function(t){n.setUnitCount(t.length);n.$tree.jstree(!0).settings.core.data=t;n.$tree.jstree("refresh")})}},t={$table:$("#OuMembersTable"),$emptyInfo:$("#OuMembersEmptyInfo"),$addUserToOuButton:$("#AddUserToOuButton"),$selectedOuRightTitle:$("#SelectedOuRightTitle"),dataTable:null,showTable:function(){t.$emptyInfo.hide();t.$table.show();t.$addUserToOuButton.show();t.$selectedOuRightTitle.text(": "+n.selectedOu.displayName).show()},hideTable:function(){t.$selectedOuRightTitle.hide();t.$addUserToOuButton.hide();t.$table.hide();t.$emptyInfo.show()},load:function(){if(!n.selectedOu.id){t.hideTable();return}t.showTable();this.dataTable.ajax.reload()},add:function(r){var u=n.selectedOu.id,f;u&&(f=_.pluck(r,"value"),i.addUsersToOrganizationUnit({organizationUnitId:u,userIds:f}).done(function(){abp.notify.success(app.localize("SuccessfullyAdded"));n.incrementMemberCount(u,f.length);t.load()}))},remove:function(r){var u=n.selectedOu.id;u&&abp.message.confirm(app.localize("RemoveUserFromOuWarningMessage",r.userName,n.selectedOu.displayName),app.localize("AreYouSure"),function(f){f&&i.removeUserFromOrganizationUnit({organizationUnitId:parseInt(u),userId:r.id}).done(function(){abp.notify.success(app.localize("SuccessfullyRemoved"));n.incrementMemberCount(u,-1);t.load()})})},openAddModal:function(){var i=n.selectedOu.id;i&&e.open({title:app.localize("SelectAUser"),organizationUnitId:i},function(n){t.add(n)})},init:function(){this.dataTable=t.$table.find(".organization-members-table").DataTable({paging:!0,serverSide:!0,processing:!0,deferLoading:0,listAction:{ajaxFunction:i.getOrganizationUnitUsers,inputFilter:function(){return{id:n.selectedOu.id}}},columnDefs:[{className:"control responsive",orderable:!1,render:function(){return""},targets:0},{targets:1,data:null,orderable:!1,defaultContent:"",className:"text-center",rowAction:{targets:0,data:null,orderable:!1,defaultContent:"",element:$("<button/>").addClass("btn btn-outline-danger m-btn m-btn--icon m-btn--icon-only m-btn--pill").attr("title",app.localize("Delete")).append($("<i/>").addClass("la la-times")).click(function(){var n=$(this).data();t.remove(n)}),visible:function(){return r.manageMembers}}},{targets:2,data:"userName"},{targets:3,data:"addedTime",render:function(n){return moment(n).format("L")}}]});$("#AddUserToOuButton").click(function(n){n.preventDefault();t.openAddModal()});t.hideTable()}};t.init();n.init()})})();