var PermissionsTree=function(n){return function(){function r(r){t=r;t.jstree({types:{"default":{icon:"fa fa-folder m--font-warning"},file:{icon:"fa fa-file  m--font-warning"}},checkbox:{keep_selected_style:!1,three_state:!1,cascade:""},plugins:["checkbox","types"]});t.on("changed.jstree",function(r,u){if(u.node){var f;u.node.state.selected?(i(t.jstree("get_parent",u.node)),f=n.makeArray(t.jstree("get_node",u.node).children),t.jstree("select_node",f)):(f=n.makeArray(t.jstree("get_node",u.node).children),t.jstree("deselect_node",f))}})}function i(n){t.jstree("select_node",n,!0);var r=t.jstree("get_parent",n);r&&i(r)}function u(){for(var i=[],r=t.jstree("get_selected",!0),n=0;n<r.length;n++)i.push(r[n].id);return i}var t;return{init:r,getSelectedPermissionNames:u}}}(jQuery),OrganizationTree=function(n){return function(){function r(){var i=!1;n("#OrganizationTreeFilter").keyup(function(){i&&clearTimeout(i);i=setTimeout(function(){var i=n("#OrganizationTreeFilter").val();t.jstree(!0).search(i)},250)})}function u(u){t=u;t.jstree({types:{"default":{icon:"fa fa-folder m--font-warning"},file:{icon:"fa fa-file  m--font-warning"}},checkbox:{keep_selected_style:!1,three_state:!1,cascade:""},search:{show_only_matches:!0},plugins:["checkbox","types","search"]});t.on("changed.jstree",function(r,u){if(u.node){var f;u.node.state.selected?(i(t.jstree("get_parent",u.node)),f=n.makeArray(t.jstree("get_node",u.node).children),t.jstree("select_node",f)):(f=n.makeArray(t.jstree("get_node",u.node).children),t.jstree("deselect_node",f))}});r()}function i(n){t.jstree("select_node",n,!0);var r=t.jstree("get_parent",n);r&&i(r)}function f(){for(var i=[],r=t.jstree("get_selected",!0),n=0;n<r.length;n++)i.push(r[n].id);return i}var t;return{init:u,getSelectedOrganizations:f}}}(jQuery);(function(n){app.modals.CreateOrEditUserModal=function(){function u(){var i=[];return t.getModal().find(".user-role-checkbox-list input[type=checkbox]").each(function(){n(this).is(":checked")&&i.push(n(this).attr("name"))}),i}var f=abp.services.app.user,t,i=null,e=new app.PasswordComplexityHelper,r;this.init=function(f){t=f;r=new OrganizationTree;r.init(t.getModal().find(".organization-tree"));i=t.getModal().find("form[name=UserInformationsForm]");i.validate();var o=t.getModal().find("input[name=Password],input[name=PasswordRepeat]"),s=o.closest(".form-group");e.setPasswordComplexityRules(o,window.passwordComplexitySetting);n("#EditUser_SetRandomPassword").change(function(){n(this).is(":checked")?(s.slideUp("fast"),t.getArgs().id||o.removeAttr("required")):(s.slideDown("fast"),t.getArgs().id||o.attr("required","required"))});t.getModal().find(".user-role-checkbox-list input[type=checkbox]").change(function(){n("#assigned-role-count").text(u().length)});t.getModal().find("[data-toggle=tooltip]").tooltip()};this.save=function(){if(i.valid()){var e=u(),n=i.serializeFormToObject();n.SetRandomPassword&&(n.Password=null);t.setBusy(!0);f.createOrUpdateUser({user:n,assignedRoleNames:e,sendActivationEmail:n.SendActivationEmail,SetRandomPassword:n.SetRandomPassword,organizationUnits:r.getSelectedOrganizations()}).done(function(){abp.notify.info(app.localize("SavedSuccessfully"));t.close();abp.event.trigger("app.createOrEditUserModalSaved")}).always(function(){t.setBusy(!1)})}}}})(jQuery),function(){app.modals.UserPermissionsModal=function(){function r(){n.setBusy(!0);i.resetUserSpecificPermissions({id:n.getArgs().id}).done(function(){abp.notify.info(app.localize("ResetSuccessfully"));n.getModal().on("hidden.bs.modal",function(){n.reopen()});n.close()}).always(function(){n.setBusy(!1)})}var i=abp.services.app.user,n,t;this.init=function(i){n=i;t=new PermissionsTree;t.init(n.getModal().find(".permission-tree"));n.getModal().find("[data-toggle=tooltip]").tooltip();n.getModal().find(".reset-permissions-button").click(function(){r()})};this.save=function(){n.setBusy(!0);i.updateUserPermissions({id:n.getArgs().id,grantedPermissionNames:t.getSelectedPermissionNames()}).done(function(){abp.notify.info(app.localize("SavedSuccessfully"));n.close()}).always(function(){n.setBusy(!1)})}}}(),function(){$(function(){function i(){e.ajax.reload()}function o(n){if(n.userName===app.consts.userManagement.defaultAdminUserName){abp.message.warn(app.localize("{0}UserCannotBeDeleted",app.consts.userManagement.defaultAdminUserName));return}abp.message.confirm(app.localize("UserDeleteWarningMessage",n.userName),app.localize("AreYouSure"),function(r){r&&t.deleteUser({id:n.id}).done(function(){i(!0);abp.notify.success(app.localize("SuccessfullyDeleted"))})})}var u=$("#UsersTable"),t=abp.services.app.user,n={create:abp.auth.hasPermission("Pages.Administration.Users.Create"),edit:abp.auth.hasPermission("Pages.Administration.Users.Edit"),changePermissions:abp.auth.hasPermission("Pages.Administration.Users.ChangePermissions"),impersonation:abp.auth.hasPermission("Pages.Administration.Users.Impersonation"),"delete":abp.auth.hasPermission("Pages.Administration.Users.Delete")},r=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Users/CreateOrEditModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Users/_CreateOrEditModal.js",modalClass:"CreateOrEditUserModal"}),f=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Users/PermissionsModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Users/_PermissionsModal.js",modalClass:"UserPermissionsModal"}),e=u.DataTable({paging:!0,serverSide:!0,processing:!0,listAction:{ajaxFunction:t.getUsers,inputFilter:function(){return{filter:$("#UsersTableFilter").val(),permission:$("#PermissionSelectionCombo").val(),role:$("#RoleSelectionCombo").val()}}},columnDefs:[{className:"control responsive",orderable:!1,render:function(){return""},targets:0},{targets:1,data:null,orderable:!1,autoWidth:!1,defaultContent:"",rowAction:{text:'<i class="fa fa-cog"><\/i> '+app.localize("Actions")+' <span class="caret"><\/span>',items:[{text:app.localize("LoginAsThisUser"),visible:function(t){return n.impersonation&&t.record.id!==abp.session.userId},action:function(n){abp.ajax({url:abp.appPath+"Account/Impersonate",data:JSON.stringify({tenantId:abp.session.tenantId,userId:n.record.id})})}},{text:app.localize("Edit"),visible:function(){return n.edit},action:function(n){r.open({id:n.record.id})}},{text:app.localize("Permissions"),visible:function(){return n.changePermissions},action:function(n){f.open({id:n.record.id})}},{text:app.localize("Unlock"),visible:function(){return n.changePermissions},action:function(n){t.unlockUser({id:n.record.id}).done(function(){abp.notify.success(app.localize("UnlockedTheUser",n.record.userName))})}},{text:app.localize("Delete"),visible:function(){return n.delete},action:function(n){o(n.record)}}]}},{targets:2,data:"userName",render:function(n,t,i){var r=$("<span/>");if(i.profilePictureId){var u="/Profile/GetProfilePictureById?id="+i.profilePictureId,f=$("<a/>").attr("href",u).attr("target","_blank"),e=$("<img/>").addClass("img-circle").attr("src",u);f.append(e);r.append(f)}return r.append(n),r[0].outerHTML}},{targets:3,data:"name"},{targets:4,data:"surname"},{targets:5,data:"roles",render:function(n){for(var t="",i=0;i<n.length;i++)t.length&&(t=t+", "),t=t+n[i].roleName;return t}},{targets:6,data:"emailAddress"},{targets:7,data:"isEmailConfirmed",render:function(n){return n?'<span class="label label-success">'+app.localize("Yes")+"<\/span>":'<span class="label label-default">'+app.localize("No")+"<\/span>"}},{targets:8,data:"isActive",render:function(n){return n?'<span class="label label-success">'+app.localize("Yes")+"<\/span>":'<span class="label label-default">'+app.localize("No")+"<\/span>"}},{targets:9,data:"lastLoginTime",render:function(n){return n?moment(n).format("L"):""}},{targets:10,data:"creationTime",render:function(n){return moment(n).format("L")}}]});$("#ShowAdvancedFiltersSpan").click(function(){$("#ShowAdvancedFiltersSpan").hide();$("#HideAdvancedFiltersSpan").show();$("#AdvacedAuditFiltersArea").slideDown()});$("#HideAdvancedFiltersSpan").click(function(){$("#HideAdvancedFiltersSpan").hide();$("#ShowAdvancedFiltersSpan").show();$("#AdvacedAuditFiltersArea").slideUp()});$("#CreateNewUserButton").click(function(){r.open()});$("#ExportUsersToExcelButton").click(function(){t.getUsersToExcel({}).done(function(n){app.downloadTempFile(n)})});$("#GetUsersButton, #RefreshUserListButton").click(function(n){n.preventDefault();i()});$("#UsersTableFilter").on("keydown",function(n){n.keyCode===13&&(n.preventDefault(),i())});abp.event.on("app.createOrEditUserModalSaved",function(){i()});$("#UsersTableFilter").focus()})}();