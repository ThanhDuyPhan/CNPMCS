var app=app||{};(function(){function i(t){abp.signalr.hubs.chat=t;n=t;t.onclose(function(n){(n?abp.log.debug("Chat connection closed with error: "+n):abp.log.debug("Caht disconnected"),abp.signalr.autoConnect)&&setTimeout(function(){t.start()},5e3)});r(t)}function t(n,t){return abp.signalr.remoteServiceBaseUrl&&(n=abp.signalr.remoteServiceBaseUrl+n),abp.signalr.qs&&(n+="?"+abp.signalr.qs),function i(r){abp.log.debug("Starting connection using "+signalR.HttpTransportType[r]+" transport");var u=(new signalR.HubConnectionBuilder).withUrl(n,r).build();return t&&typeof t=="function"&&t(u),u.start().then(function(){return u}).catch(function(n){return(abp.log.debug("Cannot start the connection using "+signalR.HttpTransportType[r]+" transport. "+n.message),r!==signalR.HttpTransportType.LongPolling)?i(r+1):Promise.reject(n)})}(signalR.HttpTransportType.WebSockets)}function r(n){n.on("getChatMessage",function(n){abp.event.trigger("app.chat.messageReceived",n)});n.on("getAllFriends",function(n){abp.event.trigger("abp.chat.friendListChanged",n)});n.on("getFriendshipRequest",function(n,t){abp.event.trigger("app.chat.friendshipRequestReceived",n,t)});n.on("getUserConnectNotification",function(n,t){abp.event.trigger("app.chat.userConnectionStateChanged",{friend:n,isConnected:t})});n.on("getUserStateChange",function(n,t){abp.event.trigger("app.chat.userStateChanged",{friend:n,state:t})});n.on("getallUnreadMessagesOfUserRead",function(n){abp.event.trigger("app.chat.allUnreadMessagesOfUserRead",{friend:n})});n.on("getReadStateChange",function(n){abp.event.trigger("app.chat.readStateChange",{friend:n})})}if(signalR){app.signalr=app.signalr||{};app.signalr.hubs=app.signalr.hubs||{};var n=null;abp.signalr.connect=function(){t("/signalr-chat",i).then(function(n){abp.log.debug("Connected to SignalR CHAT server!");abp.event.trigger("app.chat.connected");n.invoke("register").then(function(){abp.log.debug("Registered to the SignalR CHAT server!")})}).catch(function(n){abp.log.debug(n.message)})};abp.signalr.startConnection=t;abp.signalr.autoConnect===undefined&&(abp.signalr.autoConnect=!0);abp.signalr.autoConnect&&abp.signalr.connect();app.chat.sendMessage=function(t,i){if(n.connection.connectionState!==1){i&&i();abp.notify.warn(app.localize("ChatIsNotConnectedWarning"));return}n.invoke("sendMessage",t).then(function(n){n&&abp.notify.warn(n);i&&i()})}}})();