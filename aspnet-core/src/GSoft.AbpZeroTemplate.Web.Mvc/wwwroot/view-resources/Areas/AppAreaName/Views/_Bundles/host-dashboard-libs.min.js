(function(){$(function(){var h=abp.services.app.hostDashboard,n=$("#HostDashboard"),u=n.find(".dashboard-report-range"),p=n.find("input[name='IncomeStatisticsDatePeriod']"),w=n.find(".expiring-tenants-table"),b=n.find(".recent-tenants-table"),k=n.find(".see-all-expiring-tenants"),d=n.find(".see-all-recent-tenants"),i=n.find(".income-statistics .income-statistics-chart"),g=n.find(".edition-statistics .caption-helper"),c=n.find(".edition-statistics .edition-statistics-chart"),nt=n.find(".income-statistics .caption-helper"),tt=n.find(".new-tenants-statistics .status-title"),it=n.find(".new-tenants-statistics .new-tenants-count"),rt=n.find(".new-subscription-statistics .status-title"),ut=n.find(".new-subscription-statistics .new-subscription-amount"),ft=n.find(".dashboard-statistics1 .dashboard-placeholder1"),et=n.find(".dashboard-statistics2 .dashboard-placeholder2"),ot=n.find(".expiring-tenants .caption-helper"),st=n.find(".recent-tenants .caption-helper"),ht=n.find("button[name='RefreshButton']"),ct=n.find(".counterup"),f=[],e=[],lt=[],at="$",vt={daily:1,weekly:2,monthly:3},t={startDate:moment().add(-7,"days").startOf("day"),endDate:moment().endOf("day")},yt=function(){u.attr("data-display-range")!=="0"&&u.find(".m-subheader__daterange-date").html(t.startDate.format("LL")+" - "+t.endDate.format("LL"))},pt=function(n,t,i,r,u){ot.text(app.localize("ExpiringTenantsHelpText",t,i));f=n;v.ajax.reload();k.data("subscriptionEndDateStart",r).data("subscriptionEndDateEnd",u).click(function(){window.open(abp.appPath+"AppAreaName/Tenants?subscriptionEndDateStart="+encodeURIComponent($(this).data("subscriptionEndDateStart"))+"&subscriptionEndDateEnd="+encodeURIComponent($(this).data("subscriptionEndDateEnd")))})},wt=function(n,t,i,r){st.text(app.localize("RecentTenantsHelpText",t,i));e=n;y.ajax.reload();d.data("creationDateStart",r).click(function(){window.open(abp.appPath+"AppAreaName/Tenants?creationDateStart="+encodeURIComponent($(this).data("creationDateStart")))})},r=function(){return t.startDate.format("L")+" - "+t.endDate.format("L")},l=function(){return $("<div/>").addClass("note").addClass("note-info").addClass("text-center").append($("<small/>").addClass("text-muted").text("- "+app.localize("NoData")+" -"))},o=function(){return parseInt(p.closest(":checked").val())},a=function(n){var s=null,u,f,e,h,c;for(nt.text(r()),u=[],f=0;f<n.length;f++)e=new Array(2),e[0]=moment(n[f].date).utc().valueOf(),e[1]=n[f].amount,u.push(e);if(lt=u,!n||n.length===0){i.html(l());return}$.plot(i,[{data:u,lines:{fill:.2,lineWidth:1},color:["#BAD9F5"]},{data:u,points:{show:!0,fill:!0,radius:4,fillColor:"#9ACAE6",lineWidth:2},color:"#9ACAE6",shadowSize:1},{data:u,lines:{show:!0,fill:!1,lineWidth:3},color:"#9ACAE6",shadowSize:0}],{xaxis:{mode:"time",timeformat:app.localize("ChartDateFormat"),minTickSize:[1,"day"],font:{lineHeight:20,style:"normal",variant:"small-caps",color:"#6F7B8A",size:10}},yaxis:{ticks:5,tickDecimals:0,tickColor:"#eee",font:{lineHeight:14,style:"normal",variant:"small-caps",color:"#6F7B8A"}},grid:{hoverable:!0,clickable:!1,tickColor:"#eee",borderColor:"#eee",borderWidth:1,margin:{bottom:20}}});h=function(){var n=$("#chartTooltip");n.length!==0&&n.remove()};c=function(n,t,i,r){h();$("<div id='chartTooltip' class='chart-tooltip'>"+i+"<br/>"+r+"<\/div >").css({position:"absolute",display:"none",top:t-60,left:n-40,border:"0",padding:"2px 6px",opacity:"0.9"}).appendTo("body").fadeIn(200)};i.bind("plothover",function(n,i,r){var f,e,h;if(r&&s!==r.dataIndex){var l=o(),u="",a=t.startDate.format("L")===t.endDate.format("L");l===vt.daily||a?u=moment(r.datapoint[0]).format("dddd, DD MMMM YYYY"):(f=r.dataIndex===r.series.data.length-1,u+=moment(r.datapoint[0]).format("LL"),f?u+=" - "+t.endDate.format("LL"):(e=r.series.data[r.dataIndex+1],u+=" - "+moment(e[0]).format("LL")));s=r.dataIndex;h=app.localize("IncomeWithAmount","<strong>"+r.datapoint[1]+at+"<\/strong>");c(r.pageX,r.pageY,u,h)}});i.bind("mouseleave",function(){s=null;h()})},bt=function(n){var i,u,t,f;if(!n||n.length===0){c.html(l());return}for(i=["#81A17E","#BA9B7C","#569BC6","#e08283","#888888"],u=[],t=0;t<n.length;t++)f={label:n[t].label,data:n[t].value},i[t]&&(f.color=i[t]),u.push(f);$.plot(c,u,{series:{pie:{show:!0,innerRadius:.3,radius:1,label:{show:!0,radius:1,formatter:function(n,t){return"<div class='pie-chart-label'>"+n+" : "+Math.round(t.percent)+"%<\/div>"},background:{opacity:.8}}}},legend:{show:!1},grid:{hoverable:!0,clickable:!0}});g.text(r())},kt=function(n){tt.text(r());it.text(n)},dt=function(n){rt.text(r());ut.text(n)},gt=function(n){ft.text(n)},ni=function(n){et.text(n)},ti=function(){ct.counterUp()},ii=function(){abp.ui.setBusy(n);h.getDashboardStatisticsData({startDate:t.startDate,endDate:t.endDate,incomeStatisticsDateInterval:o()}).done(function(n){kt(n.newTenantsCount);dt(n.newSubscriptionAmount);gt(n.dashboardPlaceholder1);ni(n.dashboardPlaceholder2);ti();a(n.incomeStatistics);bt(n.editionStatistics);pt(n.expiringTenants,n.subscriptionEndAlertDayCount,n.maxExpiringTenantsShownCount,n.subscriptionEndDateStart,n.subscriptionEndDateEnd);wt(n.recentTenants,n.recentTenantsDayCount,n.maxRecentTenantsShownCount,n.tenantCreationStartDate)}).always(function(){abp.ui.clearBusy(n)})},s=function(){yt();ii()},ri=function(){abp.ui.setBusy(i);h.getIncomeStatistics({startDate:t.startDate.format("YYYY-MM-DDT00:00:00Z"),endDate:t.endDate.format("YYYY-MM-DDT23:59:59.999Z"),incomeStatisticsDateInterval:o()}).done(function(n){a(n.incomeStatistics)}).always(function(){abp.ui.clearBusy(i)})},ui=function(){n.find("input[name='IncomeStatisticsDatePeriod']").change(function(){this.checked&&ri()})},v=null,fi=function(){v=w.DataTable({paging:!1,serverSide:!1,processing:!1,info:!1,listAction:{ajaxFunction:function(){return $.Deferred(function(n){n.resolve({items:f,totalCount:f.length})})}},columnDefs:[{targets:0,data:"tenantName"},{targets:1,data:"remainingDayCount"}]})},y=null,ei=function(){y=b.DataTable({paging:!1,serverSide:!1,processing:!1,info:!1,listAction:{ajaxFunction:function(){return $.Deferred(function(n){n.resolve({items:e,totalCount:e.length})})}},columnDefs:[{targets:0,data:"name"},{targets:1,data:"creationTime",render:function(n){return moment(n).format("L LT")}}]})},oi=function(){ui();fi();ei();s()};u.daterangepicker($.extend(!0,app.createDateRangePickerOptions(),t),function(n,i){t.startDate=n;t.endDate=i;s()});ht.click(function(){s()});oi()})})();