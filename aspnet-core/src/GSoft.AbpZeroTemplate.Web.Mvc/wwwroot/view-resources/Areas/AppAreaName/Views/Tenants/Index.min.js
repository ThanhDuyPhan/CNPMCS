(function(){$(function(){function r(){g.ajax.reload()}function nt(n){abp.message.confirm(app.localize("TenantDeleteWarningMessage",n.tenancyName),app.localize("AreYouSure"),function(t){t&&e.deleteTenant({id:n.id}).done(function(){r();abp.notify.success(app.localize("SuccessfullyDeleted"))})})}var e=abp.services.app.tenant,a=$("#TenantsTable"),l=$("#TenantsTableFilter"),u=$("#TenantsFormFilter"),o=$("#TenantsTable_SubscriptionEndDateRangeActive"),s=u.find("input[name='SubscriptionEndDateRange']"),h=$("#TenantsTable_CreationDateRangeActive"),c=u.find("input[name='CreationDateRange']"),v=u.find("button[name='RefreshButton']"),y=u.find("#EditionDropdown"),f={create:abp.auth.hasPermission("Pages.Tenants.Create"),edit:abp.auth.hasPermission("Pages.Tenants.Edit"),changeFeatures:abp.auth.hasPermission("Pages.Tenants.ChangeFeatures"),impersonation:abp.auth.hasPermission("Pages.Tenants.Impersonation"),"delete":abp.auth.hasPermission("Pages.Tenants.Delete")},n={creationDateStart:$.url("?creationDateStart"),creationDateEnd:$.url("?creationDateEnd"),subscriptionEndDateStart:$.url("?subscriptionEndDateStart"),subscriptionEndDateEnd:$.url("?subscriptionEndDateEnd")},t={startDate:n.subscriptionEndDateStart?moment(n.subscriptionEndDateStart):moment().startOf("day"),endDate:n.subscriptionEndDateEnd?moment(n.subscriptionEndDateEnd):moment().add(30,"days").endOf("day")},i={startDate:n.creationDateStart?moment(n.creationDateStart):moment().add(-7,"days").startOf("day"),endDate:n.creationDateEnd?moment(n.creationDateEnd):moment().endOf("day")};s.daterangepicker($.extend(!0,app.createDateRangePickerOptions({allowFutureDate:!0}),t),function(n,i){t.startDate=n;t.endDate=i});c.daterangepicker($.extend(!0,app.createDateRangePickerOptions(),i),function(n,t){i.startDate=n;i.endDate=t});var p=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Tenants/CreateModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Tenants/_CreateModal.js",modalClass:"CreateTenantModal"}),w=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Tenants/EditModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Tenants/_EditModal.js",modalClass:"EditTenantModal"}),b=new app.ModalManager({viewUrl:abp.appPath+"AppAreaName/Tenants/FeaturesModal",scriptUrl:abp.appPath+"view-resources/Areas/AppAreaName/Views/Tenants/_FeaturesModal.js",modalClass:"TenantFeaturesModal"}),k=app.modals.LookupModal.create({title:app.localize("SelectAUser"),serviceMethod:abp.services.app.commonLookup.findUsers}),d=function(){var r=y.find(":selected").val(),n={filter:l.val(),editionId:r,editionIdSpecified:r!=="-1"};return h.prop("checked")&&(n.creationDateStart=i.startDate,n.creationDateEnd=i.endDate),o.prop("checked")&&(n.subscriptionEndDateStart=t.startDate,n.subscriptionEndDateEnd=t.endDate),n},g=a.DataTable({paging:!0,serverSide:!0,processing:!0,listAction:{ajaxFunction:e.getTenants,inputFilter:function(){return d()}},columnDefs:[{className:"control responsive",orderable:!1,render:function(){return""},targets:0},{targets:1,data:null,orderable:!1,autoWidth:!1,defaultContent:"",rowAction:{text:'<i class="fa fa-cog"><\/i> '+app.localize("Actions")+' <span class="caret"><\/span>',items:[{text:app.localize("LoginAsThisTenant"),visible:function(){return f.impersonation},action:function(n){k.open({extraFilters:{tenantId:n.record.id},title:app.localize("SelectAUser")},function(t){abp.ajax({url:abp.appPath+"Account/Impersonate",data:JSON.stringify({tenantId:n.record.id,userId:parseInt(t.value)}),success:function(){app.supportsTenancyNameInUrl||abp.multiTenancy.setTenantIdCookie(n.record.id)}})})}},{text:app.localize("Edit"),visible:function(){return f.edit},action:function(n){w.open({id:n.record.id})}},{text:app.localize("Features"),visible:function(){return f.changeFeatures},action:function(n){b.open({id:n.record.id})}},{text:app.localize("Delete"),visible:function(){return f.delete},action:function(n){nt(n.record)}},{text:app.localize("Unlock"),action:function(n){e.unlockTenantAdmin({id:n.record.id}).done(function(){abp.notify.success(app.localize("UnlockedTenandAdmin",n.record.name))})}}]}},{targets:2,data:"tenancyName"},{targets:3,data:"name"},{targets:4,data:"editionDisplayName"},{targets:5,data:"subscriptionEndDateUtc",render:function(n){return n?moment(n).format("L"):""}},{targets:6,data:"isActive",render:function(n){return n?'<span class="label label-success">'+app.localize("Yes")+"<\/span>":'<span class="label label-default">'+app.localize("No")+"<\/span>"}},{targets:7,data:"creationTime",render:function(n){return moment(n).format("L")}}]});$("#CreateNewTenantButton").click(function(){p.open()});$("#GetTenantsButton").click(function(n){n.preventDefault();r()});abp.event.on("app.editTenantModalSaved",function(){r(!0)});abp.event.on("app.createTenantModalSaved",function(){r(!0)});o.change(function(){s.prop("disabled",!$(this).prop("checked"))});n.subscriptionEndDateStart||n.subscriptionEndDateEnd?o.prop("checked",!0):s.prop("disabled",!0);h.change(function(){c.prop("disabled",!$(this).prop("checked"))});n.creationDateStart||n.creationDateEnd?h.prop("checked",!0):c.prop("disabled",!0);v.click(function(n){n.preventDefault();r()});l.focus()})})();